## Техническое Задание: Сервис обработки запросов с использованием цепочек промтов и AI

### 1. Введение

Настоящее техническое задание (ТЗ) описывает требования к разработке программного сервиса, предназначенного для автоматизированной обработки пользовательских запросов путем взаимодействия с внешними API и использования моделей Large Language Model (LLM) через API OpenAI, применяя заранее определенные цепочки промтов. Сервис должен обеспечивать гибкость в настройке и управлении этими цепочками.

**1.1. Назначение сервиса**
Сервис предназначен для извлечения, ранжирования, обработки и синтеза информации из предоставленной базы знаний в ответ на пользовательские запросы, используя многошаговую обработку с помощью LLM.

**1.2. Цели**
*   Автоматизация процесса ответа на пользовательские запросы на основе структурированных данных.
*   Повышение качества и релевантности ответов за счет применения многоэтапной обработки LLM.
*   Предоставление гибкого механизма для модификации и расширения логики обработки запросов через управление цепочками промтов.

### 2. Общее описание системы

Сервис будет функционировать как бэкенд-компонент, который получает пользовательский запрос, взаимодействует с внешним источником данных (по API), затем последовательно обрабатывает полученные данные с помощью API OpenAI, используя заранее определенную цепочку промтов. Результатом работы сервиса будет структурированный ответ, сформированный на основе выбранных и обработанных данных.

**2.1. Архитектура**
Предполагается микросервисная или монолитная архитектура, где ключевыми компонентами будут:
*   Модуль взаимодействия с внешними API (источник данных).
*   Модуль управления цепочками промтов.
*   Модуль взаимодействия с OpenAI API.
*   Модуль обработки и агрегации результатов.

**2.2. Основные компоненты**
*   **API-клиент:** Отвечает за отправку запросов к внешнему источнику данных и получение результатов.
*   **Prompt Manager:** Компонент для хранения, загрузки и динамического формирования цепочек промтов.
*   **LLM Processor:** Компонент, который оркестрирует вызовы к OpenAI API, передавая промты и данные, и обрабатывая ответы. Будет использовать фреймворк LangChain.
*   **Response Formatter:** Компонент для финального форматирования ответа пользователю.

### 3. Функциональные требования

**3.1. Взаимодействие с внешним API**

*   **FR.1.1: Отправка POST-запросов.** Сервис должен уметь отправлять POST-запросы к заданному внешнему API.
    *   **FR.1.1.1:** Запросы должны содержать тело (payload) в формате JSON или другом, определяемом внешним API.
    *   **FR.1.1.2:** Должна быть возможность конфигурирования URL, заголовков и параметров запроса.
*   **FR.1.2: Обработка полученных данных.** Сервис должен парсить полученный ответ от внешнего API, извлекая необходимые данные (например, список документов с полями `номер документа`, `заголовок`, `скор`, `абзац`).
    *   **FR.1.2.1:** Обработка ошибок при получении ответа (таймаут, невалидный формат, HTTP-статусы).

**3.2. Взаимодействие с API OpenAI (Цепочка промтов)**

*   **FR.2.1: Общие требования к работе с OpenAI.**
    *   **FR.2.1.1:** Использование OpenAI API для выполнения задач, определенных промтами.
    *   **FR.2.1.2:** Интеграция с помощью фреймворка LangChain для создания и управления цепочками LLM.
    *   **FR.2.1.3:** Поддержка использования LangChain `PromptTemplate` для структурирования промтов.
*   **FR.2.2: Реализация Промта 1 (Ранжирование/Выбор документов).**
    *   **Входные данные:**
        *   `вопрос` пользователя.
        *   `материалы` (результат выдачи от внешнего API) в формате:
            ```
            [номер документа: <номер>
             заголовок: <заголовок>
             скор: <скор>
             абзац: <абзац>
            ...]
            ```
    *   **Логика:** Модель должна оценить предоставленные материалы и выбрать наиболее подходящие, основываясь на следующих критериях:
        *   Соответствие абзаца вопросу.
        *   Соответствие заголовка вопросу.
        *   Отсутствие противоречий.
        *   Достаточность информации.
        *   Выбрать один лучший материал, если он полностью отвечает на вопрос, или несколько, если из них можно составить ответ. Если в документах нет информации, отвечающей на вопрос, — написать "В базе знаний нет информации".
    *   **Формат промта (пример):**
        ```
        Промт 1:
        выбираем лучшие абзацы

        Вот запрос пользователя:[вопрос]. Ранжировщик предложил эти материалы:

        [номер документа 1]

        [номер документа 2]

        [номер документа 3]

        [номер документа 4]

        Оцени, какой из них наиболее точно, полно и достоверно отвечает на вопрос.
        Учитывай:

        Соответствие абзаца вопросу.

        Соответствие заголовка вопросу.

        Отсутствие противоречий.

        Достаточность информации.

        Выбери один лучший материал, если он полностью отвечает на вопрос или несколько, если из них можно составить ответ. Если в документах нет информации, которая отвечает на вопрос,  — напиши "В базе знаний нет информации".
        Формат ответа:
        [номер документа 1]
        [номер документа 4]
        ```
    *   **Формат вывода:** Список номеров выбранных документов или строка "В базе знаний нет информации".
*   **FR.2.3: Реализация Промта 2 (Извлечение информации).**
    *   **Входные данные:**
        *   Выбранные документы (полный текст) из предыдущего шага.
        *   `вопрос` пользователя.
    *   **Логика:** Модель должна извлечь информацию, строго соответствующую запросу, сохраняя при этом фактическое содержание, исходный порядок предложений, логические связи, общие правила и исключения. **Запрещены** домыслы, интерпретации, добавление информации. Если в запросе упоминается информация, которой нет в базе, — ответить "В базе знаний нет информации".
    *   **Формат промта (пример):**
        ```
        Промт 2:
        Ты — специалист, который работает ТОЛЬКО с предоставленными данными. Твоя задача — составлять ответы, полностью сохраняя:
        1. Фактическое содержание из базы знаний
        2. Исходный порядок предложений
        3. Логические связи между утверждениями
        4. Общее правило и исключение, если такие есть
        Правила:
        - НИКАКИХ домыслов, интерпретаций или добавления информации
        - Сохраняй все формулировки дословно, как в источнике
        - Строго соблюдай последовательность предложений из исходного текста. Если в исходных данных сначала идет предложение А, затем Б — в ответе должен быть ТОЧНО такой же порядок
        - Не меняй причинно-следственные связи. "Если в тексте указано 'Из-за X произошло Y' — запрещено менять на 'Y произошло потому что X'"
        - Если в запросе упоминается информация, которой нет в базе — отвечай "В базе знаний нет информации"
        Формат ответа:
        [Предложение 1, номер документа]
        ...
        ```
    *   **Формат вывода:** Список предложений с указанием номера документа, каждое предложение в квадратных скобках `[Предложение, номер_документа]`, или строка "В базе знаний нет информации".
*   **FR.2.4: Реализация Промта 3 (Формирование ответа).**
    *   **Входные данные:**
        *   Выбранные предложения из предыдущего шага.
        *   `вопрос` пользователя.
    *   **Логика:** Модель должна собрать финальный ответ из выбранных предложений, сохраняя оригинальную формулировку и ТОЧНЫЙ порядок из исходного текста. Не добавлять связок типа "следовательно", "таким образом", "важно отметить", если их не было в оригинале. Номера документов должны быть расположены под ответом.
    *   **Формат промта (пример):**
        ```
        Промт 3:
        собираем ответ из выбранных предложений

        Выбери только предложения, которые отвечают на вопрос [срок подачи заявления в ифнс по смене директора] и составь из них ответ по формату ниже:
        1. Сохрани их оригинальную формулировку
        2. Расположи в ТОЧНОМ порядке, как в исходном тексте
        3. Не добавляй связок типа "следовательно", "таким образом",”важно отметить”, если их не было в оригинале
        4. Номера документов расположи под ответом в формате: «Подробную информацию ищите в документах»
        Формат ответа  [
        Вопрос 1  [дмс изменение срока договора налоговый учет]
        Заголовок [Изменение срока договора ДМС и его налоговый учет]
        Текст [При изменении срока договора добровольного медицинского страхования (ДМС) следует учитывать, что если новый договор заключен на срок менее одного года, то платежи по нему не могут быть учтены в расходах при расчете налога на прибыль. Это связано с тем, что для признания расходов на ДМС необходимо, чтобы договор действовал не менее одного года. В случае расторжения договора по инициативе страхователя, если он действовал менее года, расходы также не подлежат учету (письма Минфина от 01.06.2023 и 11.06.2021). Таким образом, важно правильно оформлять изменения в договорах, чтобы избежать негативных последствий для налогообложения.
         Подробную информацию ищите в документах:
         86_534385
        16_557888
        12_788389
        Вопрос 2  [ндс на усн когда платить 2025]
        ```
    *   **Формат вывода:** Структурированный JSON-подобный текст с полями "Вопрос", "Заголовок" (если применимо, можно генерировать обобщенный заголовок на основе вопроса и ответа), "Текст" и "Подробную информацию ищите в документах" со списком номеров документов.

**3.3. Гибкость и конфигурирование цепочки промтов**

*   **FR.3.1: Добавление новых промтов.** Должна быть возможность добавлять новые шаги обработки (новые промты) в цепочку без изменения кодовой базы.
*   **FR.3.2: Изменение существующих промтов.** Должна быть возможность изменять текст и логику существующих промтов (например, через конфигурационные файлы, базу данных или отдельный интерфейс).
*   **FR.3.3: Удаление промтов.** Должна быть возможность удалять промты из цепочки.
*   **FR.3.4: Управление порядком промтов.** Должна быть возможность определять и изменять порядок выполнения промтов в цепочке.
*   **FR.3.5: Управление входными/выходными данными промтов.** Система должна обеспечивать передачу результата работы одного промта в качестве входных данных для следующего промта в цепочке. (Это ключевая особенность LangChain для Prompt Chaining).

### 4. Нефункциональные требования

*   **Производительность:** Время ответа сервиса должно быть минимизировано, обеспечивая приемлемое пользовательское ожидание (например, не более 5-10 секунд для типичного запроса, с учетом задержек OpenAI API).
*   **Надежность:** Сервис должен быть устойчив к временным сбоям внешних API и OpenAI API (например, через механизмы повторных попыток).
*   **Безопасность:**
    *   Использование API-ключей OpenAI должно быть безопасным (например, через переменные окружения, а не жестко закодировано).
    *   Обработка пользовательских данных должна соответствовать требованиям конфиденциальности.
*   **Масштабируемость:** Архитектура должна допускать горизонтальное масштабирование для обработки увеличивающегося числа запросов.
*   **Сопровождаемость:** Код должен быть чистым, хорошо документированным и легко поддерживаемым. Конфигурация промтов должна быть интуитивно понятной.
*   **Журналирование и мониторинг:** Должна быть реализована система логирования для отслеживания хода выполнения запросов, ошибок и производительности.

### 5. Технические требования

*   **Язык разработки:** Python.
*   **Используемый фреймворк:** LangChain (для построения цепочек LLM и управления промтами).
*   **Библиотеки:**
    *   `requests` для выполнения HTTP-запросов к внешним API.
    *   `openai` для взаимодействия с OpenAI API.
    *   Дополнительные библиотеки LangChain (например, `langchain_openai`, `langchain_core`).
*   **Управление конфигурацией:** Параметры внешних API (URL, ключи), API-ключи OpenAI, а также определения цепочек промтов должны быть конфигурируемыми (например, через файлы `.env`, `.yaml` или базу данных).

### 6. Интерфейсы

*   **Входящий интерфейс сервиса:** RESTful API (например, POST-запрос с JSON-телом, содержащим `вопрос` пользователя).
*   **Исходящий интерфейс сервиса:** RESTful API-вызовы к внешнему источнику данных и к OpenAI API.
*   **Внутренние интерфейсы:** Взаимодействие между компонентами сервиса (например, через Python-функции/классы).

### 7. Глоссарий

*   **LLM (Large Language Model):** Большая языковая модель, такая как OpenAI GPT.
*   **Промт (Prompt):** Входной текст или инструкция, передаваемая LLM для получения желаемого ответа.
*   **Цепочка промтов (Prompt Chain):** Последовательность LLM-вызовов, где вывод одного шага служит входом для следующего.
*   **Ранжировщик:** Компонент или логика в Промте 1, отвечающая за выбор наиболее релевантных документов.
*   **База знаний:** Набор документов, полученных от внешнего API, используемых для формирования ответа.
